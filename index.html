<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Control de finanzas personales - Estado de Resultados, Balance General, Flujo de Efectivo">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWlzIEZpbmFuemFzIiwic2hvcnRfbmFtZSI6IkZpbmFuemFzIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2YxZjVmOSIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsInN0YXJ0X3VybCI6Ii4iLCJpY29ucyI6W119">
    <title>Mis Finanzas Personales</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --green: #16a34a;
            --red: #dc2626;
            --orange: #ea580c;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --nav-height: 56px;
            --bottom-nav-height: 64px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-tap-highlight-color: transparent; -webkit-text-size-adjust: 100%; }

        /* ===== TOP HEADER (mobile: simple title, desktop: full nav) ===== */
        .top-header { background: var(--primary); padding: 0 24px; display: flex; align-items: center; height: var(--nav-height); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
        .top-header h1 { color: #fff; font-size: 18px; font-weight: 700; margin-right: auto; white-space: nowrap; }
        /* Desktop nav links inside top header */
        .desktop-nav { display: flex; gap: 4px; }
        .desktop-nav button { background: transparent; border: none; color: rgba(255,255,255,.7); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all .2s; }
        .desktop-nav button.active, .desktop-nav button:hover { background: rgba(255,255,255,.2); color: #fff; }

        /* ===== BOTTOM TAB BAR (mobile only) ===== */
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; background: #fff; border-top: 1px solid var(--border); padding-bottom: var(--safe-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,.08); }
        .bottom-nav-inner { display: flex; justify-content: space-around; height: var(--bottom-nav-height); }
        .bottom-nav button { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; border: none; background: none; color: var(--text-light); font-size: 10px; font-weight: 500; cursor: pointer; transition: color .2s; padding: 4px 0; position: relative; }
        .bottom-nav button svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 1.8; }
        .bottom-nav button.active { color: var(--primary); }
        .bottom-nav button.active::after { content: ''; position: absolute; top: 0; left: 25%; right: 25%; height: 3px; background: var(--primary); border-radius: 0 0 3px 3px; }

        /* LAYOUT */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }

        /* CARDS */
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.08); border: 1px solid var(--border); }
        .card h2 { font-size: 16px; color: var(--text); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .card h3 { font-size: 14px; color: var(--text-light); margin-bottom: 8px; }

        /* SUMMARY CARDS */
        .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .summary-card { background: var(--card); border-radius: 12px; padding: 16px 20px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,.06); }
        .summary-card .label { font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; }
        .summary-card .value { font-size: 24px; font-weight: 700; }
        .summary-card .value.positive { color: var(--green); }
        .summary-card .value.negative { color: var(--red); }
        .summary-card .value.neutral { color: var(--primary); }

        /* CHART GRID (desktop 2-col, mobile 1-col) */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* FORMS */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .form-group { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
        .form-group label { font-size: 12px; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; outline: none; transition: border-color .2s; -webkit-appearance: none; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s; min-height: 44px; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-danger { background: var(--red); color: #fff; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-sm { padding: 6px 12px; font-size: 12px; min-height: 36px; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-light); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* TABLE */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 12px; background: #f8fafc; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--text-light); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; white-space: nowrap; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
        tr:hover { background: #f8fafc; }
        .amount-positive { color: var(--green); font-weight: 600; }
        .amount-negative { color: var(--red); font-weight: 600; }

        /* TAGS */
        .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .tag-ingreso { background: #dcfce7; color: #166534; }
        .tag-gasto { background: #fee2e2; color: #991b1b; }
        .tag-cat { background: #e0e7ff; color: #3730a3; }

        /* FINANCIAL STATEMENTS */
        .fs-section { margin-bottom: 16px; }
        .fs-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 14px; border-bottom: 1px solid #f1f5f9; gap: 8px; }
        .fs-row:hover { background: #f8fafc; margin: 0 -8px; padding: 6px 8px; border-radius: 4px; }
        .fs-row.total { font-weight: 700; border-top: 2px solid var(--text); border-bottom: 2px solid var(--text); margin-top: 4px; padding-top: 8px; font-size: 15px; }
        .fs-row.subtotal { font-weight: 600; border-top: 1px solid var(--border); padding-top: 6px; }
        .fs-header { font-weight: 700; font-size: 14px; color: var(--primary); padding: 10px 0 4px; border-bottom: 1px solid var(--primary); margin-bottom: 4px; }
        .indent { padding-left: 16px; }
        .indent2 { padding-left: 32px; }

        /* UPLOAD AREA */
        .upload-area { border: 2px dashed var(--border); border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all .2s; margin-bottom: 16px; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: #eff6ff; }
        .upload-area svg { width: 40px; height: 40px; color: var(--text-light); margin-bottom: 10px; }
        .upload-area p { color: var(--text-light); font-size: 14px; }
        .upload-area .upload-hint { font-size: 12px; color: var(--text-light); margin-top: 8px; }

        /* IMAGE PREVIEW */
        .image-preview { max-width: 100%; max-height: 300px; border-radius: 8px; margin: 12px 0; border: 1px solid var(--border); }

        /* EXTRACTED TRANSACTIONS */
        .extracted-list { margin-top: 12px; }
        .extracted-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .extracted-item input, .extracted-item select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
        .extracted-item .ext-desc { flex: 2; min-width: 120px; }
        .extracted-item .ext-amount { width: 90px; text-align: right; }
        .extracted-item .ext-cat { flex: 1; min-width: 100px; }
        .extracted-item .ext-type { width: 90px; }

        /* CAPITAL MOVEMENT CHART */
        .capital-chart-container { position: relative; height: 260px; padding: 10px 0 30px 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .capital-chart-svg { width: 100%; height: 100%; min-width: 300px; }
        .capital-chart-legend { display: flex; gap: 16px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .capital-chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-light); }
        .capital-chart-legend-dot { width: 12px; height: 3px; border-radius: 2px; }
        .capital-summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
        .capital-summary-card { text-align: center; padding: 10px 6px; border-radius: 10px; border: 1px solid var(--border); }
        .capital-summary-card .cs-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; letter-spacing: .5px; }
        .capital-summary-card .cs-value { font-size: 16px; font-weight: 700; margin-top: 2px; }
        .capital-delta { font-size: 11px; margin-top: 2px; }
        .capital-delta.up { color: var(--green); }
        .capital-delta.down { color: var(--red); }

        /* CHART PLACEHOLDER */
        .chart-container { height: 200px; display: flex; align-items: flex-end; gap: 4px; padding: 10px 0; }
        .chart-bar { flex: 1; border-radius: 4px 4px 0 0; transition: height .3s; position: relative; min-width: 20px; cursor: pointer; }
        .chart-bar:hover .chart-tooltip { display: block; }
        .chart-tooltip { display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: var(--text); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; }
        .chart-labels { display: flex; gap: 4px; }
        .chart-labels span { flex: 1; text-align: center; font-size: 10px; color: var(--text-light); min-width: 20px; }
        .chart-legend { display: flex; gap: 16px; margin-top: 8px; justify-content: center; }
        .chart-legend-item { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-light); }
        .chart-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

        /* PIE CHART */
        .pie-container { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .pie-svg { width: 180px; height: 180px; }
        .pie-legend { font-size: 13px; }
        .pie-legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .pie-legend-color { width: 12px; height: 12px; border-radius: 3px; }

        /* FILTERS */
        .filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.4); z-index: 200; justify-content: center; align-items: center; padding: 16px; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: 12px; padding: 20px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 16px; font-size: 16px; }

        /* PERIOD TABS */
        .period-tabs { display: flex; gap: 4px; margin-bottom: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
        .period-tabs::-webkit-scrollbar { display: none; }
        .period-tabs button { padding: 8px 14px; border: 1px solid var(--border); background: #fff; border-radius: 8px; font-size: 13px; cursor: pointer; color: var(--text-light); white-space: nowrap; flex-shrink: 0; }
        .period-tabs button.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* DELETE BTN */
        .delete-btn { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 18px; padding: 4px 8px; border-radius: 4px; min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center; }
        .delete-btn:hover { color: var(--red); background: #fee2e2; }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 30px 16px; color: var(--text-light); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: .5; }

        /* PROCESSING */
        .processing { display: flex; align-items: center; gap: 10px; padding: 16px; background: #eff6ff; border-radius: 8px; margin: 12px 0; }
        .spinner { width: 20px; height: 20px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .api-key-notice { background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: #92400e; }
        .api-key-notice a { color: var(--primary); }

        /* Tabs within upload */
        .upload-tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
        .upload-tabs button { padding: 8px 16px; border: 1px solid var(--border); background: #fff; border-radius: 8px; font-size: 13px; cursor: pointer; flex: 1; min-width: 120px; text-align: center; }
        .upload-tabs button.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .manual-entry-section { display: none; }
        .manual-entry-section.active { display: block; }

        /* BALANCE GENERAL - TWO COLUMN LAYOUT */
        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .balance-col { min-width: 0; }
        .balance-col .fs-header { font-size: 15px; padding: 8px 12px; background: #f8fafc; border-radius: 8px 8px 0 0; margin-bottom: 0; border-bottom: 2px solid var(--primary); }
        .balance-col.col-activos .fs-header { color: var(--green); border-color: var(--green); }
        .balance-col.col-pasivos .fs-header { color: var(--red); border-color: var(--red); }
        .bs-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f1f5f9; gap: 6px; transition: background .15s; }
        .bs-item:hover { background: #f8fafc; }
        .bs-item-name { font-size: 12px; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bs-item-amount { display: flex; align-items: center; gap: 2px; }
        .bs-item-amount input { width: 110px; padding: 6px 8px; border: 1px solid transparent; border-radius: 6px; font-size: 13px; text-align: right; font-weight: 600; background: transparent; transition: all .2s; }
        .bs-item-amount input:hover { border-color: var(--border); background: #fff; }
        .bs-item-amount input:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 2px rgba(37,99,235,.15); }
        .bs-sub-header { padding: 6px 12px; font-size: 11px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .5px; background: #f1f5f9; border-bottom: 1px solid var(--border); }
        .bs-subtotal { display: flex; justify-content: space-between; padding: 8px 12px; font-weight: 700; font-size: 13px; border-top: 1px solid var(--border); background: #f8fafc; }
        .bs-total { display: flex; justify-content: space-between; padding: 10px 12px; font-weight: 700; font-size: 14px; border-top: 2px solid var(--text); border-bottom: 2px solid var(--text); margin-top: 4px; }
        .bs-capital-section { margin-top: 16px; border-top: 2px solid var(--primary); padding-top: 12px; }
        .bs-update-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .bs-last-update { font-size: 13px; color: var(--text-light); }
        .bs-last-update strong { color: var(--text); }
        .bs-save-btn { display: none; }
        .bs-save-btn.visible { display: inline-flex; }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 768px) {
            /* Hide desktop nav, show bottom tab bar */
            .desktop-nav { display: none !important; }
            .bottom-nav { display: block; }
            .top-header { height: 48px; padding: 0 16px; }
            .top-header h1 { font-size: 16px; }

            /* Body padding for bottom nav */
            body { padding-bottom: calc(var(--bottom-nav-height) + var(--safe-bottom) + 8px); }

            /* Container */
            .container { padding: 12px 10px; }

            /* Cards */
            .card { padding: 14px; margin-bottom: 12px; border-radius: 10px; }
            .card h2 { font-size: 14px; margin-bottom: 12px; }

            /* Summary row */
            .summary-row { grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
            .summary-card { padding: 12px 10px; border-radius: 10px; }
            .summary-card .label { font-size: 10px; }
            .summary-card .value { font-size: 18px; }

            /* Charts grid stacks vertically */
            .charts-grid { grid-template-columns: 1fr; gap: 12px; }

            /* Forms stack vertically */
            .form-row { flex-direction: column; gap: 8px; }
            .form-group { min-width: 100% !important; flex: unset !important; }
            .form-group input, .form-group select { padding: 12px; font-size: 16px; }
            .btn { width: 100%; min-height: 48px; font-size: 15px; }
            .btn-sm { width: auto; min-height: 40px; font-size: 13px; }

            /* Tables - allow horizontal scroll */
            table { font-size: 12px; }
            th, td { padding: 8px 6px; }

            /* Financial statements */
            .fs-row { font-size: 13px; padding: 5px 0; }
            .fs-row.total { font-size: 14px; }
            .indent { padding-left: 12px; }
            .indent2 { padding-left: 24px; }

            /* Balance grid stacks vertically */
            .balance-grid { grid-template-columns: 1fr; gap: 16px; }
            .bs-item { padding: 8px 8px; }
            .bs-item-name { font-size: 11px; }
            .bs-item-amount input { width: 100px; font-size: 12px; padding: 6px 4px; }
            .bs-subtotal, .bs-total { font-size: 12px; padding: 8px 8px; }
            .bs-update-bar { flex-direction: column; align-items: stretch; }

            /* Capital summary */
            .capital-summary-card .cs-value { font-size: 14px; }
            .capital-summary-card .cs-label { font-size: 9px; }
            .capital-chart-container { height: 200px; padding: 5px 0 25px 5px; }

            /* Period tabs scroll horizontally */
            .period-tabs { gap: 6px; }
            .period-tabs button { padding: 8px 12px; font-size: 12px; }

            /* Upload area */
            .upload-area { padding: 24px 16px; }
            .upload-area svg { width: 36px; height: 36px; }
            .upload-area p { font-size: 13px; }

            /* Extracted items stack on mobile */
            .extracted-item { flex-direction: column; align-items: stretch; gap: 6px; }
            .extracted-item input, .extracted-item select { width: 100% !important; min-width: 0 !important; font-size: 14px; padding: 10px; }
            .extracted-item .ext-desc { min-width: 0; }

            /* Filters wrap */
            .filters { gap: 6px; }
            .filters select, .filters input { flex: 1; min-width: 0; font-size: 14px; padding: 10px 8px; }

            /* Modal fullscreen on mobile */
            .modal-overlay { padding: 8px; align-items: flex-end; }
            .modal { border-radius: 16px 16px 8px 8px; max-height: 90vh; padding: 16px; }

            /* Pie chart */
            .pie-container { flex-direction: column; }
            .pie-svg { width: 150px; height: 150px; }
            .pie-legend { font-size: 12px; }
        }

        /* Extra small screens */
        @media (max-width: 380px) {
            .summary-row { grid-template-columns: 1fr; }
            .summary-card .value { font-size: 16px; }
            .capital-summary-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- TOP HEADER -->
<nav class="top-header">
    <h1>üí∞ Mis Finanzas</h1>
    <div class="desktop-nav">
        <button class="active" data-page="dashboard" onclick="showPage('dashboard',this)">Dashboard</button>
        <button data-page="transacciones" onclick="showPage('transacciones',this)">Transacciones</button>
        <button data-page="estado-resultados" onclick="showPage('estado-resultados',this)">Estado de Resultados</button>
        <button data-page="balance" onclick="showPage('balance',this)">Balance General</button>
        <button data-page="flujo" onclick="showPage('flujo',this)">Flujo de Efectivo</button>
    </div>
</nav>

<!-- BOTTOM NAV (mobile) -->
<nav class="bottom-nav">
    <div class="bottom-nav-inner">
        <button class="active" data-page="dashboard" onclick="showPage('dashboard',this)">
            <svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Inicio</span>
        </button>
        <button data-page="transacciones" onclick="showPage('transacciones',this)">
            <svg viewBox="0 0 24 24"><path d="M12 6v12m-8-6h16" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Movimientos</span>
        </button>
        <button data-page="estado-resultados" onclick="showPage('estado-resultados',this)">
            <svg viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Resultados</span>
        </button>
        <button data-page="balance" onclick="showPage('balance',this)">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Balance</span>
        </button>
        <button data-page="flujo" onclick="showPage('flujo',this)">
            <svg viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Flujo</span>
        </button>
    </div>
</nav>

<div class="container">

    <!-- ==================== DASHBOARD ==================== -->
    <div id="page-dashboard" class="page active">
        <div class="summary-row" id="dashboard-summary"></div>

        <!-- CAPITAL MOVEMENT SECTION -->
        <div class="card">
            <h2>üìà Movimiento de Capital</h2>
            <div class="capital-summary-row" id="capital-summary"></div>
            <div class="capital-chart-container" id="capital-chart"></div>
            <div class="capital-chart-legend">
                <div class="capital-chart-legend-item"><div class="capital-chart-legend-dot" style="background:#22c55e;"></div> Activos</div>
                <div class="capital-chart-legend-item"><div class="capital-chart-legend-dot" style="background:#ef4444;"></div> Pasivos</div>
                <div class="capital-chart-legend-item"><div class="capital-chart-legend-dot" style="background:#3b82f6;"></div> Capital</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="card">
                <h2>üìä Ingresos vs Gastos (Mensual)</h2>
                <div id="chart-monthly"></div>
            </div>
            <div class="card">
                <h2>ü•ß Gastos por Categoria</h2>
                <div id="chart-categories"></div>
            </div>
        </div>

        <div class="card">
            <h2>üìã Ultimas Transacciones</h2>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Descripcion</th><th>Categoria</th><th>Tipo</th><th>Monto</th></tr></thead>
                    <tbody id="recent-transactions"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== TRANSACCIONES ==================== -->
    <div id="page-transacciones" class="page">
        <div class="card">
            <h2>‚ûï Nueva Transaccion</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="tx-date">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="tx-type">
                        <option value="ingreso">Ingreso</option>
                        <option value="gasto">Gasto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="tx-category">
                        <!-- Se llena dinamicamente -->
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Descripcion</label>
                    <input type="text" id="tx-desc" placeholder="Ej: Pago de nomina">
                </div>
                <div class="form-group" style="flex: 0 0 150px;">
                    <label>Monto ($)</label>
                    <input type="number" id="tx-amount" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="form-group" style="flex: 0 0 auto; justify-content: flex-end;">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="addTransaction()">Agregar</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üè∑Ô∏è Cuentas Contables Personalizadas</h2>
            <p style="font-size:13px;color:var(--text-light);margin-bottom:12px;">Crea categorias adicionales para clasificar tus ingresos o gastos.</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre de la Cuenta</label>
                    <input type="text" id="new-cat-name" placeholder="Ej: Honorarios, Mascotas, Uber Eats...">
                </div>
                <div class="form-group" style="flex: 0 0 160px;">
                    <label>Tipo</label>
                    <select id="new-cat-type">
                        <option value="gasto">Gasto</option>
                        <option value="ingreso">Ingreso</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 0 0 auto; justify-content: flex-end;">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="addCustomCategory()">+ Crear Cuenta</button>
                </div>
            </div>
            <div id="custom-categories-list"></div>
        </div>

        <div class="card">
            <h2>üì∏ Importar Estado de Cuenta</h2>
            <p style="font-size:13px;color:var(--text-light);margin-bottom:16px;">
                Sube una foto o captura de pantalla de tu estado de cuenta bancario.
                El sistema clasificara automaticamente tus gastos e ingresos.
            </p>

            <div class="api-key-notice" id="api-key-section">
                <strong>Configuracion API:</strong> Para el reconocimiento automatico de imagenes, necesitas una API key de Anthropic (Claude).
                <a href="https://console.anthropic.com/" target="_blank">Obtener API Key</a>
                <div class="form-row" style="margin-top:8px;margin-bottom:0;">
                    <div class="form-group" style="margin-bottom:0;">
                        <input type="password" id="anthropic-key" placeholder="sk-ant-..." style="font-size:13px;">
                    </div>
                    <div class="form-group" style="flex:0 0 auto;margin-bottom:0;">
                        <button class="btn btn-primary btn-sm" onclick="saveApiKey()">Guardar Key</button>
                    </div>
                </div>
                <p style="margin-top:6px;font-size:11px;">Tambien puedes usar el modo manual sin API key. Usa Claude (Anthropic) para la clasificacion inteligente.</p>
            </div>

            <div class="upload-tabs">
                <button class="active" onclick="switchUploadMode('auto',this)">Automatico (con Claude AI)</button>
                <button onclick="switchUploadMode('manual',this)">Manual (sin AI)</button>
            </div>

            <!-- AUTO MODE -->
            <div id="upload-auto" class="manual-entry-section active">
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p><strong>Arrastra tu imagen aqui</strong> o haz clic para seleccionar</p>
                    <p class="upload-hint">Soporta JPG, PNG, PDF - Estado de cuenta o recibo</p>
                </div>
                <input type="file" id="file-input" hidden accept="image/*,.pdf" onchange="handleFileUpload(event)">
                <div id="upload-preview" style="display:none;"></div>
                <div id="upload-processing" style="display:none;" class="processing">
                    <div class="spinner"></div>
                    <span>Analizando imagen con Claude AI... Clasificando transacciones...</span>
                </div>
                <div id="extracted-results" style="display:none;"></div>
            </div>

            <!-- MANUAL MODE -->
            <div id="upload-manual" class="manual-entry-section">
                <div class="upload-area" id="upload-area-manual" onclick="document.getElementById('file-input-manual').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p><strong>Sube tu imagen</strong> como referencia visual</p>
                    <p class="upload-hint">Luego ingresa las transacciones manualmente abajo</p>
                </div>
                <input type="file" id="file-input-manual" hidden accept="image/*,.pdf" onchange="handleManualFileUpload(event)">
                <div id="manual-preview" style="display:none;"></div>

                <h3 style="margin: 16px 0 8px;">Agregar transacciones manualmente:</h3>
                <div id="manual-entries">
                    <div class="extracted-item">
                        <input type="date" class="ext-date" style="width:130px;">
                        <input type="text" class="ext-desc" placeholder="Descripcion">
                        <input type="number" class="ext-amount" placeholder="Monto" step="0.01">
                        <select class="ext-type">
                            <option value="gasto">Gasto</option>
                            <option value="ingreso">Ingreso</option>
                        </select>
                        <select class="ext-cat" id="manual-cat-initial">
                            <!-- Se llena dinamicamente -->
                        </select>
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="btn btn-outline btn-sm" onclick="addManualEntry()">+ Agregar fila</button>
                    <button class="btn btn-success btn-sm" onclick="saveManualEntries()">Guardar todas</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìã Todas las Transacciones</h2>
            <div class="filters">
                <select id="filter-type" onchange="renderTransactions()">
                    <option value="todos">Todos los tipos</option>
                    <option value="ingreso">Ingresos</option>
                    <option value="gasto">Gastos</option>
                </select>
                <select id="filter-cat" onchange="renderTransactions()">
                    <option value="todos">Todas las categorias</option>
                </select>
                <input type="month" id="filter-month" onchange="renderTransactions()">
                <button class="btn btn-outline btn-sm" onclick="clearFilters()">Limpiar filtros</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Descripcion</th><th>Categoria</th><th>Tipo</th><th>Monto</th><th></th></tr></thead>
                    <tbody id="all-transactions"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== ESTADO DE RESULTADOS ==================== -->
    <div id="page-estado-resultados" class="page">
        <div class="period-tabs" id="er-period-tabs"></div>
        <div class="card">
            <h2>üìÑ Estado de Resultados</h2>
            <div id="income-statement"></div>
        </div>
    </div>

    <!-- ==================== BALANCE GENERAL ==================== -->
    <div id="page-balance" class="page">
        <div class="card">
            <h2>üìä Balance General</h2>
            <div class="bs-update-bar">
                <div class="bs-last-update" id="balance-date-info"></div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-success btn-sm bs-save-btn" id="bs-save-btn" onclick="saveBalanceUpdates()">üíæ Guardar Cambios</button>
                    <button class="btn btn-outline btn-sm" onclick="document.getElementById('bs-add-modal').classList.add('active')">+ Agregar Cuenta</button>
                </div>
            </div>
            <div id="balance-sheet"></div>
        </div>

        <!-- MODAL: Add Balance Item -->
        <div class="modal-overlay" id="bs-add-modal">
            <div class="modal">
                <h2>Agregar Cuenta al Balance</h2>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Concepto</label>
                    <input type="text" id="bs-name" placeholder="Ej: Cuenta bancaria">
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Tipo</label>
                    <select id="bs-type">
                        <optgroup label="Activos">
                            <option value="activo-circulante">Activo Circulante</option>
                            <option value="activo-fijo">Activo Fijo</option>
                        </optgroup>
                        <optgroup label="Pasivos">
                            <option value="pasivo-corto">Pasivo a Corto Plazo</option>
                            <option value="pasivo-largo">Pasivo a Largo Plazo</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:16px;">
                    <label>Monto ($)</label>
                    <input type="number" id="bs-amount" step="0.01" min="0" placeholder="0.00">
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-outline" onclick="document.getElementById('bs-add-modal').classList.remove('active')">Cancelar</button>
                    <button class="btn btn-primary" onclick="addBalanceItem()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FLUJO DE EFECTIVO ==================== -->
    <div id="page-flujo" class="page">
        <div class="period-tabs" id="cf-period-tabs"></div>
        <div class="card">
            <h2>üíµ Estado de Flujo de Efectivo</h2>
            <div id="cash-flow"></div>
        </div>
    </div>


</div>

<script>
// ============================================
// DATA STORE
// ============================================
const STORAGE_KEY = 'misfinanzas_data';

function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
    return {
        transactions: [],
        balanceItems: [],
        customCategories: [],
        apiKey: ''
    };
}

function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

let appData = loadData();
if (!appData.customCategories) appData.customCategories = [];
if (!appData.balanceHistory) appData.balanceHistory = [];

// ============================================
// DEFAULT CATEGORIES
// ============================================
const DEFAULT_INCOME_CATS = ['Salario', 'Freelance', 'Inversiones', 'Ventas', 'Otros Ingresos'];
const DEFAULT_EXPENSE_CATS = ['Alimentacion', 'Transporte', 'Vivienda', 'Servicios', 'Salud', 'Educacion',
    'Entretenimiento', 'Ropa', 'Seguros', 'Suscripciones', 'Restaurantes', 'Gasolina', 'Mantenimiento',
    'Impuestos', 'Deudas', 'Otros Gastos'];

function getAllCategories(type) {
    const custom = appData.customCategories.filter(c => c.type === type);
    if (type === 'ingreso') {
        return [...DEFAULT_INCOME_CATS, ...custom.map(c => c.name)];
    } else {
        return [...DEFAULT_EXPENSE_CATS, ...custom.map(c => c.name)];
    }
}

function getAllCategoriesFlat() {
    const customIncome = appData.customCategories.filter(c => c.type === 'ingreso').map(c => c.name);
    const customExpense = appData.customCategories.filter(c => c.type === 'gasto').map(c => c.name);
    return {
        ingresos: [...DEFAULT_INCOME_CATS, ...customIncome],
        gastos: [...DEFAULT_EXPENSE_CATS, ...customExpense],
        all: [...DEFAULT_INCOME_CATS, ...customIncome, ...DEFAULT_EXPENSE_CATS, ...customExpense]
    };
}

function getCategoryOptionsHTML() {
    const cats = getAllCategoriesFlat();
    return `
        <optgroup label="Ingresos">
            ${cats.ingresos.map(c => `<option value="${c}">${c}</option>`).join('')}
        </optgroup>
        <optgroup label="Gastos">
            ${cats.gastos.map(c => `<option value="${c}">${c}</option>`).join('')}
        </optgroup>
    `;
}

function getCategorySimpleOptionsHTML() {
    const cats = getAllCategoriesFlat();
    return cats.all.map(c => `<option value="${c}">${c}</option>`).join('');
}

function addCustomCategory() {
    const name = document.getElementById('new-cat-name').value.trim();
    const type = document.getElementById('new-cat-type').value;
    if (!name) { alert('Escribe un nombre para la cuenta contable'); return; }
    // Check duplicates
    const all = getAllCategoriesFlat().all;
    if (all.includes(name)) { alert('Ya existe una cuenta con ese nombre'); return; }
    appData.customCategories.push({ name, type });
    saveData(appData);
    document.getElementById('new-cat-name').value = '';
    refreshCategorySelects();
    renderCustomCategories();
    alert(`Cuenta "${name}" creada como ${type === 'ingreso' ? 'Ingreso' : 'Gasto'}`);
}

function deleteCustomCategory(name) {
    // Check if in use
    const inUse = appData.transactions.some(t => t.category === name);
    if (inUse) {
        if (!confirm(`La cuenta "${name}" tiene transacciones asociadas. Si la eliminas, esas transacciones conservaran la categoria pero ya no aparecera en los selectores. ¬øContinuar?`)) return;
    }
    appData.customCategories = appData.customCategories.filter(c => c.name !== name);
    saveData(appData);
    refreshCategorySelects();
    renderCustomCategories();
}

function renderCustomCategories() {
    const container = document.getElementById('custom-categories-list');
    if (!container) return;
    if (appData.customCategories.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light);font-size:13px;padding:8px 0;">No hay cuentas contables personalizadas.</p>';
        return;
    }
    container.innerHTML = appData.customCategories.map(c => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#f8fafc;border-radius:6px;margin-bottom:4px;">
            <span style="font-size:13px;">
                <span class="tag ${c.type === 'ingreso' ? 'tag-ingreso' : 'tag-gasto'}" style="margin-right:6px;">${c.type === 'ingreso' ? 'Ingreso' : 'Gasto'}</span>
                ${c.name}
            </span>
            <button class="delete-btn" onclick="deleteCustomCategory('${c.name.replace(/'/g, "\\'")}')" title="Eliminar">√ó</button>
        </div>
    `).join('');
}

function refreshCategorySelects() {
    // Update the main transaction category select
    const txCat = document.getElementById('tx-category');
    if (txCat) {
        const currentVal = txCat.value;
        txCat.innerHTML = getCategoryOptionsHTML();
        if (currentVal && [...txCat.options].some(o => o.value === currentVal)) txCat.value = currentVal;
    }
}

// ============================================
// NAVIGATION
// ============================================
function showPage(page, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    // Update desktop nav
    document.querySelectorAll('.desktop-nav button').forEach(b => b.classList.remove('active'));
    const desktopBtn = document.querySelector(`.desktop-nav button[data-page="${page}"]`);
    if (desktopBtn) desktopBtn.classList.add('active');
    // Update bottom nav
    document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
    const bottomBtn = document.querySelector(`.bottom-nav button[data-page="${page}"]`);
    if (bottomBtn) bottomBtn.classList.add('active');
    // Scroll to top
    window.scrollTo(0, 0);
    refreshAll();
}

// ============================================
// TRANSACTIONS
// ============================================
function addTransaction() {
    const date = document.getElementById('tx-date').value;
    const type = document.getElementById('tx-type').value;
    const category = document.getElementById('tx-category').value;
    const desc = document.getElementById('tx-desc').value;
    const amount = parseFloat(document.getElementById('tx-amount').value);

    if (!date || !desc || !amount) {
        alert('Completa todos los campos');
        return;
    }

    appData.transactions.push({
        id: Date.now(),
        date, type, category, description: desc, amount
    });

    saveData(appData);
    document.getElementById('tx-desc').value = '';
    document.getElementById('tx-amount').value = '';
    refreshAll();
}

function deleteTransaction(id) {
    appData.transactions = appData.transactions.filter(t => t.id !== id);
    saveData(appData);
    refreshAll();
}

function renderTransactions() {
    const filterType = document.getElementById('filter-type').value;
    const filterCat = document.getElementById('filter-cat').value;
    const filterMonth = document.getElementById('filter-month').value;

    let txs = [...appData.transactions].sort((a, b) => b.date.localeCompare(a.date));

    if (filterType !== 'todos') txs = txs.filter(t => t.type === filterType);
    if (filterCat !== 'todos') txs = txs.filter(t => t.category === filterCat);
    if (filterMonth) txs = txs.filter(t => t.date.startsWith(filterMonth));

    const tbody = document.getElementById('all-transactions');
    if (txs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-light);padding:30px;">No hay transacciones</td></tr>';
        return;
    }

    tbody.innerHTML = txs.map(t => `
        <tr>
            <td>${formatDate(t.date)}</td>
            <td>${t.description}</td>
            <td><span class="tag tag-cat">${t.category}</span></td>
            <td><span class="tag ${t.type === 'ingreso' ? 'tag-ingreso' : 'tag-gasto'}">${t.type === 'ingreso' ? 'Ingreso' : 'Gasto'}</span></td>
            <td class="${t.type === 'ingreso' ? 'amount-positive' : 'amount-negative'}">${t.type === 'ingreso' ? '+' : '-'}MX$${formatNum(t.amount)}</td>
            <td><button class="delete-btn" onclick="deleteTransaction(${t.id})" title="Eliminar">√ó</button></td>
        </tr>
    `).join('');
}

function renderRecentTransactions() {
    const txs = [...appData.transactions].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 8);
    const tbody = document.getElementById('recent-transactions');
    if (txs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light);padding:30px;">Agrega tu primera transaccion para empezar</td></tr>';
        return;
    }
    tbody.innerHTML = txs.map(t => `
        <tr>
            <td>${formatDate(t.date)}</td>
            <td>${t.description}</td>
            <td><span class="tag tag-cat">${t.category}</span></td>
            <td><span class="tag ${t.type === 'ingreso' ? 'tag-ingreso' : 'tag-gasto'}">${t.type === 'ingreso' ? 'Ingreso' : 'Gasto'}</span></td>
            <td class="${t.type === 'ingreso' ? 'amount-positive' : 'amount-negative'}">${t.type === 'ingreso' ? '+' : '-'}MX$${formatNum(t.amount)}</td>
        </tr>
    `).join('');
}

// ============================================
// DASHBOARD
// ============================================
function renderDashboard() {
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    const monthTxs = appData.transactions.filter(t => t.date.startsWith(currentMonth));

    const totalIngresos = monthTxs.filter(t => t.type === 'ingreso').reduce((s, t) => s + t.amount, 0);
    const totalGastos = monthTxs.filter(t => t.type === 'gasto').reduce((s, t) => s + t.amount, 0);
    const balance = totalIngresos - totalGastos;
    const allTimeBalance = appData.transactions.reduce((s, t) => s + (t.type === 'ingreso' ? t.amount : -t.amount), 0);

    document.getElementById('dashboard-summary').innerHTML = `
        <div class="summary-card">
            <div class="label">Ingresos del Mes</div>
            <div class="value positive">+MX$${formatNum(totalIngresos)}</div>
        </div>
        <div class="summary-card">
            <div class="label">Gastos del Mes</div>
            <div class="value negative">-MX$${formatNum(totalGastos)}</div>
        </div>
        <div class="summary-card">
            <div class="label">Balance del Mes</div>
            <div class="value ${balance >= 0 ? 'positive' : 'negative'}">${balance >= 0 ? '+' : ''}MX$${formatNum(balance)}</div>
        </div>
        <div class="summary-card">
            <div class="label">Balance Acumulado</div>
            <div class="value neutral">MX$${formatNum(allTimeBalance)}</div>
        </div>
    `;

    renderMonthlyChart();
    renderCategoryPie();
    renderRecentTransactions();
}

function renderMonthlyChart() {
    const months = getLastNMonths(6);
    let maxVal = 0;
    const data = months.map(m => {
        const txs = appData.transactions.filter(t => t.date.startsWith(m));
        const ing = txs.filter(t => t.type === 'ingreso').reduce((s, t) => s + t.amount, 0);
        const gas = txs.filter(t => t.type === 'gasto').reduce((s, t) => s + t.amount, 0);
        maxVal = Math.max(maxVal, ing, gas);
        return { month: m, ingresos: ing, gastos: gas };
    });

    if (maxVal === 0) maxVal = 1;

    const container = document.getElementById('chart-monthly');
    container.innerHTML = `
        <div class="chart-container">
            ${data.map(d => `
                <div class="chart-bar" style="height:${(d.ingresos / maxVal) * 100}%;background:${d.ingresos > 0 ? '#22c55e' : '#e2e8f0'};opacity:0.8;">
                    <div class="chart-tooltip">+MX$${formatNum(d.ingresos)}</div>
                </div>
                <div class="chart-bar" style="height:${(d.gastos / maxVal) * 100}%;background:${d.gastos > 0 ? '#ef4444' : '#e2e8f0'};opacity:0.8;">
                    <div class="chart-tooltip">-MX$${formatNum(d.gastos)}</div>
                </div>
            `).join('')}
        </div>
        <div class="chart-labels">
            ${data.map(d => `<span style="flex:2;">${d.month.slice(5)}</span>`).join('')}
        </div>
        <div class="chart-legend">
            <div class="chart-legend-item"><div class="chart-legend-dot" style="background:#22c55e;"></div> Ingresos</div>
            <div class="chart-legend-item"><div class="chart-legend-dot" style="background:#ef4444;"></div> Gastos</div>
        </div>
    `;
}

function renderCategoryPie() {
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    const gastos = appData.transactions.filter(t => t.type === 'gasto' && t.date.startsWith(currentMonth));

    const catTotals = {};
    gastos.forEach(t => {
        catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
    });

    const entries = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
    const total = entries.reduce((s, e) => s + e[1], 0);
    const colors = ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'];

    const container = document.getElementById('chart-categories');
    if (entries.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No hay gastos este mes</p></div>';
        return;
    }

    // Build SVG pie chart
    let cumulativePercent = 0;
    const slices = entries.map((e, i) => {
        const percent = e[1] / total;
        const startAngle = cumulativePercent * 2 * Math.PI;
        cumulativePercent += percent;
        const endAngle = cumulativePercent * 2 * Math.PI;
        const largeArc = percent > 0.5 ? 1 : 0;
        const x1 = 90 + 80 * Math.cos(startAngle - Math.PI / 2);
        const y1 = 90 + 80 * Math.sin(startAngle - Math.PI / 2);
        const x2 = 90 + 80 * Math.cos(endAngle - Math.PI / 2);
        const y2 = 90 + 80 * Math.sin(endAngle - Math.PI / 2);

        if (entries.length === 1) {
            return `<circle cx="90" cy="90" r="80" fill="${colors[i % colors.length]}"/>`;
        }
        return `<path d="M90,90 L${x1},${y1} A80,80 0 ${largeArc},1 ${x2},${y2} Z" fill="${colors[i % colors.length]}"/>`;
    });

    container.innerHTML = `
        <div class="pie-container">
            <svg class="pie-svg" viewBox="0 0 180 180">${slices.join('')}</svg>
            <div class="pie-legend">
                ${entries.map((e, i) => `
                    <div class="pie-legend-item">
                        <div class="pie-legend-color" style="background:${colors[i % colors.length]};"></div>
                        <span>${e[0]}: MX$${formatNum(e[1])} (${(e[1]/total*100).toFixed(0)}%)</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// ============================================
// CAPITAL MOVEMENT DASHBOARD
// ============================================
function saveBalanceSnapshot() {
    // Save current balance state as a snapshot with today's date
    const items = appData.balanceItems;
    const totalActivos = items.filter(i => i.type.startsWith('activo')).reduce((s, i) => s + i.amount, 0);
    const totalPasivos = items.filter(i => i.type.startsWith('pasivo')).reduce((s, i) => s + i.amount, 0);
    const capital = totalActivos - totalPasivos;
    const date = appData.balanceLastUpdate || new Date().toISOString().slice(0, 10);

    // Replace snapshot for same date, or add new
    const existing = appData.balanceHistory.findIndex(h => h.date === date);
    const snapshot = { date, activos: totalActivos, pasivos: totalPasivos, capital };
    if (existing >= 0) {
        appData.balanceHistory[existing] = snapshot;
    } else {
        appData.balanceHistory.push(snapshot);
        appData.balanceHistory.sort((a, b) => a.date.localeCompare(b.date));
    }
    saveData(appData);
}

function renderCapitalChart() {
    const history = appData.balanceHistory || [];
    const summaryEl = document.getElementById('capital-summary');
    const chartEl = document.getElementById('capital-chart');

    // If no history yet, compute current snapshot and show it
    if (history.length === 0 && appData.balanceItems.length > 0) {
        saveBalanceSnapshot();
    }

    const data = appData.balanceHistory || [];

    if (data.length === 0) {
        summaryEl.innerHTML = '';
        chartEl.innerHTML = '<div class="empty-state"><p>Guarda actualizaciones del balance para ver el movimiento de capital</p></div>';
        return;
    }

    // Summary cards: current values + delta from first snapshot
    const current = data[data.length - 1];
    const previous = data.length > 1 ? data[data.length - 2] : current;
    const deltaActivos = current.activos - previous.activos;
    const deltaPasivos = current.pasivos - previous.pasivos;
    const deltaCapital = current.capital - previous.capital;

    const deltaHTML = (val) => {
        if (data.length <= 1) return '';
        const sign = val >= 0 ? '+' : '';
        const cls = val >= 0 ? 'up' : 'down';
        return `<div class="capital-delta ${cls}">${sign}MX$${formatNum(val)}</div>`;
    };

    summaryEl.innerHTML = `
        <div class="capital-summary-card">
            <div class="cs-label">Total Activos</div>
            <div class="cs-value amount-positive">MX$${formatNum(current.activos)}</div>
            ${deltaHTML(deltaActivos)}
        </div>
        <div class="capital-summary-card">
            <div class="cs-label">Total Pasivos</div>
            <div class="cs-value amount-negative">MX$${formatNum(current.pasivos)}</div>
            ${deltaHTML(-deltaPasivos)}
        </div>
        <div class="capital-summary-card">
            <div class="cs-label">Capital Neto</div>
            <div class="cs-value" style="color:var(--primary);">MX$${formatNum(current.capital)}</div>
            ${deltaHTML(deltaCapital)}
        </div>
    `;

    // Draw line chart with SVG
    if (data.length < 2) {
        chartEl.innerHTML = `
            <div style="text-align:center;padding:30px;color:var(--text-light);font-size:13px;">
                <p><strong>Capital actual: MX$${formatNum(current.capital)}</strong></p>
                <p style="margin-top:8px;">Actualiza el balance semanalmente para ver la grafica de movimiento</p>
            </div>
        `;
        return;
    }

    const W = 700, H = 220, PAD_L = 10, PAD_R = 10, PAD_T = 20, PAD_B = 40;
    const plotW = W - PAD_L - PAD_R;
    const plotH = H - PAD_T - PAD_B;

    // Find min/max across all series
    let allVals = [];
    data.forEach(d => { allVals.push(d.activos, d.pasivos, d.capital); });
    let minVal = Math.min(...allVals);
    let maxVal = Math.max(...allVals);
    const range = maxVal - minVal || 1;
    minVal -= range * 0.05;
    maxVal += range * 0.05;
    const totalRange = maxVal - minVal;

    const xScale = (i) => PAD_L + (i / (data.length - 1)) * plotW;
    const yScale = (v) => PAD_T + plotH - ((v - minVal) / totalRange) * plotH;

    const makeLine = (series, color) => {
        const points = data.map((d, i) => `${xScale(i)},${yScale(d[series])}`);
        return `<polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>`;
    };

    const makeDots = (series, color) => {
        return data.map((d, i) => {
            const x = xScale(i);
            const y = yScale(d[series]);
            return `<circle cx="${x}" cy="${y}" r="4" fill="${color}" stroke="#fff" stroke-width="1.5">
                <title>${formatDate(d.date)}: MX$${formatNum(d[series])}</title>
            </circle>`;
        }).join('');
    };

    // X-axis labels
    const xLabels = data.map((d, i) => {
        const x = xScale(i);
        const label = d.date.slice(5); // MM-DD
        return `<text x="${x}" y="${H - 5}" text-anchor="middle" font-size="10" fill="#94a3b8">${label}</text>`;
    }).join('');

    // Y-axis grid lines (4 lines)
    let gridLines = '';
    for (let i = 0; i <= 4; i++) {
        const val = minVal + (totalRange / 4) * i;
        const y = yScale(val);
        gridLines += `<line x1="${PAD_L}" y1="${y}" x2="${W - PAD_R}" y2="${y}" stroke="#e2e8f0" stroke-width="0.5"/>`;
        // Abbreviate values (millions/thousands)
        let label;
        if (Math.abs(val) >= 1000000) label = (val / 1000000).toFixed(1) + 'M';
        else if (Math.abs(val) >= 1000) label = (val / 1000).toFixed(0) + 'K';
        else label = val.toFixed(0);
        gridLines += `<text x="${PAD_L - 5}" y="${y + 4}" text-anchor="end" font-size="9" fill="#94a3b8">${label}</text>`;
    }

    chartEl.innerHTML = `
        <svg class="capital-chart-svg" viewBox="-50 0 ${W + 50} ${H}" preserveAspectRatio="xMidYMid meet">
            ${gridLines}
            ${makeLine('activos', '#22c55e')}
            ${makeLine('pasivos', '#ef4444')}
            ${makeLine('capital', '#3b82f6')}
            ${makeDots('activos', '#22c55e')}
            ${makeDots('pasivos', '#ef4444')}
            ${makeDots('capital', '#3b82f6')}
            ${xLabels}
        </svg>
    `;
}

// ============================================
// ESTADO DE RESULTADOS (Income Statement)
// ============================================
function renderIncomeStatement() {
    const periods = getAvailableMonths();
    const tabsEl = document.getElementById('er-period-tabs');

    if (periods.length === 0) {
        tabsEl.innerHTML = '';
        document.getElementById('income-statement').innerHTML = '<div class="empty-state"><p>Agrega transacciones para ver tu estado de resultados</p></div>';
        return;
    }

    const selectedPeriod = tabsEl.dataset.selected || periods[0];
    tabsEl.innerHTML = periods.slice(0, 12).map(p =>
        `<button class="${p === selectedPeriod ? 'active' : ''}" onclick="selectERPeriod('${p}')">${getMonthName(p)}</button>`
    ).join('');

    const txs = appData.transactions.filter(t => t.date.startsWith(selectedPeriod));
    const ingresos = txs.filter(t => t.type === 'ingreso');
    const gastos = txs.filter(t => t.type === 'gasto');

    // Group by category
    const ingByCat = groupByCategory(ingresos);
    const gasByCat = groupByCategory(gastos);

    const totalIngresos = ingresos.reduce((s, t) => s + t.amount, 0);
    const totalGastos = gastos.reduce((s, t) => s + t.amount, 0);
    const utilidadBruta = totalIngresos - totalGastos;

    let html = `
        <div class="fs-section">
            <div class="fs-header">INGRESOS</div>
            ${ingByCat.map(c => `<div class="fs-row indent"><span>${c.category}</span><span>MX$${formatNum(c.total)}</span></div>`).join('')}
            <div class="fs-row subtotal"><span><strong>Total Ingresos</strong></span><span class="amount-positive"><strong>MX$${formatNum(totalIngresos)}</strong></span></div>
        </div>
        <div class="fs-section">
            <div class="fs-header">GASTOS</div>
            ${gasByCat.map(c => `<div class="fs-row indent"><span>${c.category}</span><span>MX$${formatNum(c.total)}</span></div>`).join('')}
            <div class="fs-row subtotal"><span><strong>Total Gastos</strong></span><span class="amount-negative"><strong>MX$${formatNum(totalGastos)}</strong></span></div>
        </div>
        <div class="fs-section">
            <div class="fs-row total">
                <span>UTILIDAD / PERDIDA NETA</span>
                <span class="${utilidadBruta >= 0 ? 'amount-positive' : 'amount-negative'}">MX$${formatNum(utilidadBruta)}</span>
            </div>
        </div>
    `;

    document.getElementById('income-statement').innerHTML = html;
}

function selectERPeriod(period) {
    document.getElementById('er-period-tabs').dataset.selected = period;
    renderIncomeStatement();
}

// ============================================
// BALANCE GENERAL (Balance Sheet)
// ============================================
let bsDirty = false;

function addBalanceItem() {
    const name = document.getElementById('bs-name').value.trim();
    const type = document.getElementById('bs-type').value;
    const amount = parseFloat(document.getElementById('bs-amount').value) || 0;

    if (!name) { alert('Escribe el nombre de la cuenta'); return; }

    appData.balanceItems.push({ id: Date.now(), name, type, amount });
    appData.balanceLastUpdate = new Date().toISOString().slice(0, 10);
    saveData(appData);
    saveBalanceSnapshot();
    document.getElementById('bs-name').value = '';
    document.getElementById('bs-amount').value = '';
    document.getElementById('bs-add-modal').classList.remove('active');
    renderBalanceSheet();
}

function deleteBalanceItem(id) {
    if (!confirm('¬øEliminar esta cuenta del balance?')) return;
    appData.balanceItems = appData.balanceItems.filter(b => b.id !== id);
    appData.balanceLastUpdate = new Date().toISOString().slice(0, 10);
    saveData(appData);
    renderBalanceSheet();
}

function onBalanceAmountChange() {
    bsDirty = true;
    document.getElementById('bs-save-btn').classList.add('visible');
    // Recalculate totals live
    recalcBalanceTotals();
}

function recalcBalanceTotals() {
    let totalAC = 0, totalAF = 0, totalPC = 0, totalPL = 0;
    document.querySelectorAll('.bs-input-amount').forEach(input => {
        const val = parseFloat(input.value) || 0;
        const type = input.dataset.bstype;
        if (type === 'activo-circulante') totalAC += val;
        else if (type === 'activo-fijo') totalAF += val;
        else if (type === 'pasivo-corto') totalPC += val;
        else if (type === 'pasivo-largo') totalPL += val;
    });
    const totalActivos = totalAC + totalAF;
    const totalPasivos = totalPC + totalPL;
    const capital = totalActivos - totalPasivos;

    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = 'MX$' + formatNum(val); };
    el('bs-total-ac', totalAC);
    el('bs-total-af', totalAF);
    el('bs-total-activos', totalActivos);
    el('bs-total-pc', totalPC);
    el('bs-total-pl', totalPL);
    el('bs-total-pasivos', totalPasivos);
    el('bs-total-capital', capital);
    el('bs-total-pasivos-capital', totalPasivos + capital);
}

function saveBalanceUpdates() {
    document.querySelectorAll('.bs-input-amount').forEach(input => {
        const id = parseFloat(input.dataset.id);
        const val = parseFloat(input.value) || 0;
        const item = appData.balanceItems.find(b => b.id === id);
        if (item) item.amount = val;
    });
    appData.balanceLastUpdate = new Date().toISOString().slice(0, 10);
    saveData(appData);
    saveBalanceSnapshot(); // Save historical snapshot for capital movement chart
    bsDirty = false;
    document.getElementById('bs-save-btn').classList.remove('visible');
    renderBalanceSheet();
    alert('Balance actualizado correctamente al ' + formatDate(appData.balanceLastUpdate));
}

function renderBalanceSheet() {
    // Date info
    const lastUpdate = appData.balanceLastUpdate || new Date().toISOString().slice(0, 10);
    document.getElementById('balance-date-info').innerHTML = `<strong>Balance al:</strong> ${formatDate(lastUpdate)}`;

    const items = appData.balanceItems;
    const sortDesc = (arr) => [...arr].sort((a, b) => b.amount - a.amount);
    const activoCirculante = sortDesc(items.filter(i => i.type === 'activo-circulante'));
    const activoFijo = sortDesc(items.filter(i => i.type === 'activo-fijo'));
    const pasivoCorto = sortDesc(items.filter(i => i.type === 'pasivo-corto'));
    const pasivoLargo = sortDesc(items.filter(i => i.type === 'pasivo-largo'));

    const totalAC = activoCirculante.reduce((s, i) => s + i.amount, 0);
    const totalAF = activoFijo.reduce((s, i) => s + i.amount, 0);
    const totalActivos = totalAC + totalAF;
    const totalPC = pasivoCorto.reduce((s, i) => s + i.amount, 0);
    const totalPL = pasivoLargo.reduce((s, i) => s + i.amount, 0);
    const totalPasivos = totalPC + totalPL;
    const capital = totalActivos - totalPasivos;

    if (items.length === 0) {
        document.getElementById('balance-sheet').innerHTML = '<div class="empty-state"><p>Agrega cuentas al balance para empezar</p></div>';
        return;
    }

    const renderEditableItems = (arr) => arr.map(i => `
        <div class="bs-item">
            <span class="bs-item-name" title="${i.name}">${i.name}</span>
            <div class="bs-item-amount">
                <span style="color:var(--text-light);font-size:12px;">MX$</span>
                <input type="number" class="bs-input-amount" value="${i.amount}" step="0.01"
                    data-id="${i.id}" data-bstype="${i.type}"
                    oninput="onBalanceAmountChange()">
                <button class="delete-btn" onclick="deleteBalanceItem(${i.id})" title="Eliminar" style="font-size:14px;">√ó</button>
            </div>
        </div>
    `).join('');

    let html = `
        <div class="balance-grid">
            <!-- COLUMNA IZQUIERDA: ACTIVOS -->
            <div class="balance-col col-activos">
                <div class="fs-header">ACTIVOS</div>

                ${activoCirculante.length ? `
                    <div class="bs-sub-header">Activo Circulante</div>
                    ${renderEditableItems(activoCirculante)}
                    <div class="bs-subtotal"><span>Subtotal Circulante</span><span id="bs-total-ac" class="amount-positive">MX$${formatNum(totalAC)}</span></div>
                ` : ''}

                ${activoFijo.length ? `
                    <div class="bs-sub-header">Activo Fijo</div>
                    ${renderEditableItems(activoFijo)}
                    <div class="bs-subtotal"><span>Subtotal Fijo</span><span id="bs-total-af" class="amount-positive">MX$${formatNum(totalAF)}</span></div>
                ` : ''}

                <div class="bs-total">
                    <span>TOTAL ACTIVOS</span>
                    <span id="bs-total-activos" class="amount-positive">MX$${formatNum(totalActivos)}</span>
                </div>
            </div>

            <!-- COLUMNA DERECHA: PASIVOS + CAPITAL -->
            <div class="balance-col col-pasivos">
                <div class="fs-header">PASIVOS</div>

                ${pasivoCorto.length ? `
                    <div class="bs-sub-header">Pasivo a Corto Plazo</div>
                    ${renderEditableItems(pasivoCorto)}
                    <div class="bs-subtotal"><span>Subtotal Corto Plazo</span><span id="bs-total-pc" class="amount-negative">MX$${formatNum(totalPC)}</span></div>
                ` : ''}

                ${pasivoLargo.length ? `
                    <div class="bs-sub-header">Pasivo a Largo Plazo</div>
                    ${renderEditableItems(pasivoLargo)}
                    <div class="bs-subtotal"><span>Subtotal Largo Plazo</span><span id="bs-total-pl" class="amount-negative">MX$${formatNum(totalPL)}</span></div>
                ` : ''}

                <div class="bs-total">
                    <span>TOTAL PASIVOS</span>
                    <span id="bs-total-pasivos" class="amount-negative">MX$${formatNum(totalPasivos)}</span>
                </div>

                <div class="bs-capital-section">
                    <div class="bs-sub-header" style="background:none;border:none;color:var(--primary);font-size:13px;font-weight:700;">CAPITAL CONTABLE</div>
                    <div class="bs-item">
                        <span class="bs-item-name">Capital (Activos - Pasivos)</span>
                        <div class="bs-item-amount">
                            <span id="bs-total-capital" style="font-weight:700;font-size:14px;" class="${capital >= 0 ? 'amount-positive' : 'amount-negative'}">MX$${formatNum(capital)}</span>
                        </div>
                    </div>
                    <div class="bs-total" style="margin-top:8px;">
                        <span>PASIVOS + CAPITAL</span>
                        <span id="bs-total-pasivos-capital">MX$${formatNum(totalPasivos + capital)}</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('balance-sheet').innerHTML = html;
    bsDirty = false;
    document.getElementById('bs-save-btn').classList.remove('visible');
}

// ============================================
// FLUJO DE EFECTIVO (Cash Flow Statement)
// ============================================
function renderCashFlow() {
    const periods = getAvailableMonths();
    const tabsEl = document.getElementById('cf-period-tabs');

    if (periods.length === 0) {
        tabsEl.innerHTML = '';
        document.getElementById('cash-flow').innerHTML = '<div class="empty-state"><p>Agrega transacciones para ver tu flujo de efectivo</p></div>';
        return;
    }

    const selectedPeriod = tabsEl.dataset.selected || periods[0];
    tabsEl.innerHTML = periods.slice(0, 12).map(p =>
        `<button class="${p === selectedPeriod ? 'active' : ''}" onclick="selectCFPeriod('${p}')">${getMonthName(p)}</button>`
    ).join('');

    const txs = appData.transactions.filter(t => t.date.startsWith(selectedPeriod));

    // Classify transactions into cash flow categories (including custom ones)
    const customIncomeCats = appData.customCategories.filter(c => c.type === 'ingreso').map(c => c.name);
    const customExpenseCats = appData.customCategories.filter(c => c.type === 'gasto').map(c => c.name);
    const operativeIncome = ['Salario', 'Freelance', 'Ventas', 'Otros Ingresos', ...customIncomeCats];
    const operativeExpense = ['Alimentacion', 'Transporte', 'Vivienda', 'Servicios', 'Salud', 'Educacion',
        'Entretenimiento', 'Ropa', 'Seguros', 'Suscripciones', 'Restaurantes', 'Gasolina', 'Mantenimiento',
        'Impuestos', 'Otros Gastos', ...customExpenseCats];
    const investmentCats = ['Inversiones'];
    const financingCats = ['Deudas'];

    // Operating activities
    const opInflows = txs.filter(t => t.type === 'ingreso' && operativeIncome.includes(t.category));
    const opOutflows = txs.filter(t => t.type === 'gasto' && operativeExpense.includes(t.category));
    const opInflowTotal = opInflows.reduce((s, t) => s + t.amount, 0);
    const opOutflowTotal = opOutflows.reduce((s, t) => s + t.amount, 0);
    const netOperating = opInflowTotal - opOutflowTotal;

    // Investment activities
    const invTxs = txs.filter(t => investmentCats.includes(t.category));
    const invInflow = invTxs.filter(t => t.type === 'ingreso').reduce((s, t) => s + t.amount, 0);
    const invOutflow = invTxs.filter(t => t.type === 'gasto').reduce((s, t) => s + t.amount, 0);
    const netInvesting = invInflow - invOutflow;

    // Financing activities
    const finTxs = txs.filter(t => financingCats.includes(t.category));
    const finInflow = finTxs.filter(t => t.type === 'ingreso').reduce((s, t) => s + t.amount, 0);
    const finOutflow = finTxs.filter(t => t.type === 'gasto').reduce((s, t) => s + t.amount, 0);
    const netFinancing = finInflow - finOutflow;

    const netCashFlow = netOperating + netInvesting + netFinancing;

    // Previous months balance
    const prevMonths = appData.transactions.filter(t => t.date < selectedPeriod + '-01');
    const prevBalance = prevMonths.reduce((s, t) => s + (t.type === 'ingreso' ? t.amount : -t.amount), 0);
    const endingBalance = prevBalance + netCashFlow;

    const renderGroup = (items) => {
        const grouped = groupByCategory(items);
        return grouped.map(c => `<div class="fs-row indent2"><span>${c.category}</span><span>MX$${formatNum(c.total)}</span></div>`).join('');
    };

    let html = `
        <div class="fs-section">
            <div class="fs-row"><span><em>Saldo Inicial del Periodo</em></span><span>MX$${formatNum(prevBalance)}</span></div>
        </div>
        <div class="fs-section">
            <div class="fs-header">ACTIVIDADES DE OPERACION</div>
            <div class="fs-row indent" style="color:var(--text-light);"><span>Entradas:</span><span></span></div>
            ${renderGroup(opInflows)}
            <div class="fs-row indent subtotal"><span>Total Entradas</span><span class="amount-positive">MX$${formatNum(opInflowTotal)}</span></div>
            <div class="fs-row indent" style="color:var(--text-light);"><span>Salidas:</span><span></span></div>
            ${renderGroup(opOutflows)}
            <div class="fs-row indent subtotal"><span>Total Salidas</span><span class="amount-negative">MX$${formatNum(opOutflowTotal)}</span></div>
            <div class="fs-row subtotal"><span><strong>Flujo Neto de Operacion</strong></span><span class="${netOperating >= 0 ? 'amount-positive' : 'amount-negative'}"><strong>MX$${formatNum(netOperating)}</strong></span></div>
        </div>
        <div class="fs-section">
            <div class="fs-header">ACTIVIDADES DE INVERSION</div>
            ${invTxs.length ? invTxs.map(t => `<div class="fs-row indent"><span>${t.description}</span><span class="${t.type === 'ingreso' ? 'amount-positive' : 'amount-negative'}">${t.type === 'ingreso' ? '+' : '-'}MX$${formatNum(t.amount)}</span></div>`).join('') : '<div class="fs-row indent" style="color:var(--text-light);"><span>Sin movimientos</span><span>MX$0.00</span></div>'}
            <div class="fs-row subtotal"><span><strong>Flujo Neto de Inversion</strong></span><span class="${netInvesting >= 0 ? 'amount-positive' : 'amount-negative'}"><strong>MX$${formatNum(netInvesting)}</strong></span></div>
        </div>
        <div class="fs-section">
            <div class="fs-header">ACTIVIDADES DE FINANCIAMIENTO</div>
            ${finTxs.length ? finTxs.map(t => `<div class="fs-row indent"><span>${t.description}</span><span class="${t.type === 'ingreso' ? 'amount-positive' : 'amount-negative'}">${t.type === 'ingreso' ? '+' : '-'}MX$${formatNum(t.amount)}</span></div>`).join('') : '<div class="fs-row indent" style="color:var(--text-light);"><span>Sin movimientos</span><span>MX$0.00</span></div>'}
            <div class="fs-row subtotal"><span><strong>Flujo Neto de Financiamiento</strong></span><span class="${netFinancing >= 0 ? 'amount-positive' : 'amount-negative'}"><strong>MX$${formatNum(netFinancing)}</strong></span></div>
        </div>
        <div class="fs-section">
            <div class="fs-row total">
                <span>CAMBIO NETO EN EFECTIVO</span>
                <span class="${netCashFlow >= 0 ? 'amount-positive' : 'amount-negative'}">MX$${formatNum(netCashFlow)}</span>
            </div>
            <div class="fs-row" style="margin-top:8px;font-weight:600;">
                <span>SALDO FINAL DEL PERIODO</span>
                <span class="${endingBalance >= 0 ? 'amount-positive' : 'amount-negative'}">MX$${formatNum(endingBalance)}</span>
            </div>
        </div>
    `;

    document.getElementById('cash-flow').innerHTML = html;
}

function selectCFPeriod(period) {
    document.getElementById('cf-period-tabs').dataset.selected = period;
    renderCashFlow();
}

// ============================================
// IMAGE UPLOAD & AI CLASSIFICATION
// ============================================
function saveApiKey() {
    appData.apiKey = document.getElementById('anthropic-key').value.trim();
    saveData(appData);
    alert('API Key guardada correctamente');
}

function switchUploadMode(mode, btn) {
    document.querySelectorAll('.upload-tabs button').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    document.getElementById('upload-auto').classList.toggle('active', mode === 'auto');
    document.getElementById('upload-manual').classList.toggle('active', mode === 'manual');
}

function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        const base64 = ev.target.result;
        const preview = document.getElementById('upload-preview');
        preview.style.display = 'block';
        preview.innerHTML = `<img src="${base64}" class="image-preview" alt="Estado de cuenta">`;

        if (appData.apiKey) {
            processWithAI(base64);
        } else {
            document.getElementById('extracted-results').style.display = 'block';
            document.getElementById('extracted-results').innerHTML = `
                <div class="api-key-notice">
                    <strong>Sin API Key:</strong> Configura tu API key de Anthropic (Claude) arriba para el reconocimiento automatico,
                    o usa el modo manual.
                </div>
            `;
        }
    };
    reader.readAsDataURL(file);
}

function handleManualFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        const preview = document.getElementById('manual-preview');
        preview.style.display = 'block';
        preview.innerHTML = `<img src="${ev.target.result}" class="image-preview" alt="Referencia">`;
    };
    reader.readAsDataURL(file);
}

async function processWithAI(base64Image) {
    document.getElementById('upload-processing').style.display = 'flex';
    document.getElementById('extracted-results').style.display = 'none';

    const allCats = getAllCategoriesFlat().all;
    const prompt = `Analiza esta imagen de un estado de cuenta bancario o recibo. Extrae todas las transacciones que puedas identificar.

Para cada transaccion, devuelve un JSON array con objetos que tengan:
- "date": fecha en formato YYYY-MM-DD (si no hay a√±o, usa 2026)
- "description": descripcion del movimiento
- "amount": monto numerico (siempre positivo)
- "type": "ingreso" o "gasto"
- "category": una de estas categorias: ${allCats.join(', ')}

Clasifica inteligentemente basandote en la descripcion. Por ejemplo:
- UBER/DIDI ‚Üí Transporte
- OXXO/WALMART/SORIANA ‚Üí Alimentacion
- NETFLIX/SPOTIFY ‚Üí Suscripciones
- RESTAURANT/STARBUCKS ‚Üí Restaurantes
- CFE/TELMEX ‚Üí Servicios
- GASOLINERA ‚Üí Gasolina

Responde SOLO con el JSON array, sin texto adicional.`;

    // Extract the base64 data and media type from the data URL
    const mediaTypeMatch = base64Image.match(/^data:(image\/\w+);base64,/);
    const mediaType = mediaTypeMatch ? mediaTypeMatch[1] : 'image/jpeg';
    const base64Data = base64Image.replace(/^data:image\/\w+;base64,/, '');

    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': appData.apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 4000,
                messages: [{
                    role: 'user',
                    content: [
                        {
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: mediaType,
                                data: base64Data
                            }
                        },
                        { type: 'text', text: prompt }
                    ]
                }]
            })
        });

        const data = await response.json();
        document.getElementById('upload-processing').style.display = 'none';

        if (data.error) {
            document.getElementById('extracted-results').style.display = 'block';
            document.getElementById('extracted-results').innerHTML = `
                <div class="api-key-notice" style="background:#fee2e2;border-color:#fca5a5;color:#991b1b;">
                    <strong>Error:</strong> ${data.error.message}
                </div>
            `;
            return;
        }

        const content = data.content[0].text;
        let transactions;
        try {
            const jsonStr = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            transactions = JSON.parse(jsonStr);
        } catch (e) {
            document.getElementById('extracted-results').style.display = 'block';
            document.getElementById('extracted-results').innerHTML = `
                <div class="api-key-notice" style="background:#fee2e2;border-color:#fca5a5;color:#991b1b;">
                    <strong>Error:</strong> No se pudo interpretar la respuesta. Intenta con otra imagen mas clara.
                </div>
            `;
            return;
        }

        showExtractedTransactions(transactions);

    } catch (err) {
        document.getElementById('upload-processing').style.display = 'none';
        document.getElementById('extracted-results').style.display = 'block';
        document.getElementById('extracted-results').innerHTML = `
            <div class="api-key-notice" style="background:#fee2e2;border-color:#fca5a5;color:#991b1b;">
                <strong>Error de conexion:</strong> ${err.message}
            </div>
        `;
    }
}

function showExtractedTransactions(transactions) {
    const container = document.getElementById('extracted-results');
    container.style.display = 'block';

    const cats = getAllCategoriesFlat();
    const categories = cats.all;

    container.innerHTML = `
        <h3 style="margin-bottom:8px;">Se encontraron ${transactions.length} transacciones:</h3>
        <p style="font-size:12px;color:var(--text-light);margin-bottom:12px;">Revisa y edita antes de guardar. Puedes cambiar categorias y tipos.</p>
        <div class="extracted-list" id="extracted-list">
            ${transactions.map((t, i) => `
                <div class="extracted-item" data-index="${i}">
                    <input type="date" class="ext-date" value="${t.date}" style="width:130px;">
                    <input type="text" class="ext-desc" value="${escapeHtml(t.description)}">
                    <input type="number" class="ext-amount" value="${t.amount}" step="0.01">
                    <select class="ext-type">
                        <option value="gasto" ${t.type === 'gasto' ? 'selected' : ''}>Gasto</option>
                        <option value="ingreso" ${t.type === 'ingreso' ? 'selected' : ''}>Ingreso</option>
                    </select>
                    <select class="ext-cat">
                        ${categories.map(c => `<option value="${c}" ${t.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    <button class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
                </div>
            `).join('')}
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn btn-success" onclick="saveExtractedTransactions()">Guardar Todas</button>
            <button class="btn btn-outline" onclick="document.getElementById('extracted-results').style.display='none';">Cancelar</button>
        </div>
    `;
}

function saveExtractedTransactions() {
    const items = document.querySelectorAll('#extracted-list .extracted-item');
    let count = 0;

    items.forEach(item => {
        const date = item.querySelector('.ext-date').value;
        const desc = item.querySelector('.ext-desc').value;
        const amount = parseFloat(item.querySelector('.ext-amount').value);
        const type = item.querySelector('.ext-type').value;
        const category = item.querySelector('.ext-cat').value;

        if (date && desc && amount > 0) {
            appData.transactions.push({
                id: Date.now() + count,
                date, type, category, description: desc, amount
            });
            count++;
        }
    });

    saveData(appData);
    alert(`Se guardaron ${count} transacciones correctamente`);
    document.getElementById('extracted-results').style.display = 'none';
    document.getElementById('upload-preview').style.display = 'none';
    refreshAll();
}

// Manual entries
function addManualEntry() {
    const container = document.getElementById('manual-entries');
    const div = document.createElement('div');
    div.className = 'extracted-item';
    div.innerHTML = `
        <input type="date" class="ext-date" style="width:130px;">
        <input type="text" class="ext-desc" placeholder="Descripcion">
        <input type="number" class="ext-amount" placeholder="Monto" step="0.01">
        <select class="ext-type">
            <option value="gasto">Gasto</option>
            <option value="ingreso">Ingreso</option>
        </select>
        <select class="ext-cat">
            ${getCategorySimpleOptionsHTML()}
        </select>
        <button class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.appendChild(div);
}

function saveManualEntries() {
    const items = document.querySelectorAll('#manual-entries .extracted-item');
    let count = 0;

    items.forEach(item => {
        const date = item.querySelector('.ext-date').value;
        const desc = item.querySelector('.ext-desc').value;
        const amount = parseFloat(item.querySelector('.ext-amount').value);
        const type = item.querySelector('.ext-type').value;
        const category = item.querySelector('.ext-cat').value;

        if (date && desc && amount > 0) {
            appData.transactions.push({
                id: Date.now() + count,
                date, type, category, description: desc, amount
            });
            count++;
        }
    });

    if (count === 0) { alert('No hay transacciones validas para guardar'); return; }

    saveData(appData);
    alert(`Se guardaron ${count} transacciones`);
    // Reset manual entries
    document.getElementById('manual-entries').innerHTML = `
        <div class="extracted-item">
            <input type="date" class="ext-date" style="width:130px;">
            <input type="text" class="ext-desc" placeholder="Descripcion">
            <input type="number" class="ext-amount" placeholder="Monto" step="0.01">
            <select class="ext-type"><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select>
            <select class="ext-cat">
                ${getCategorySimpleOptionsHTML()}
            </select>
        </div>
    `;
    refreshAll();
}

// ============================================
// DRAG & DROP
// ============================================
['upload-area', 'upload-area-manual'].forEach(id => {
    const area = document.getElementById(id);
    if (!area) return;
    area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
    area.addEventListener('dragleave', () => area.classList.remove('dragover'));
    area.addEventListener('drop', e => {
        e.preventDefault();
        area.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (!file) return;
        const inputId = id === 'upload-area' ? 'file-input' : 'file-input-manual';
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById(inputId).files = dt.files;
        document.getElementById(inputId).dispatchEvent(new Event('change'));
    });
});

// ============================================
// HELPERS
// ============================================
function formatNum(n) {
    return Math.abs(n).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatMXN(n) {
    return '$' + formatNum(n);
}

function formatDate(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function getMonthName(ym) {
    const d = new Date(ym + '-15');
    return d.toLocaleDateString('es-MX', { month: 'short', year: 'numeric' });
}

function getLastNMonths(n) {
    const months = [];
    const now = new Date();
    for (let i = 0; i < n; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push(d.toISOString().slice(0, 7));
    }
    return months.reverse();
}

function getAvailableMonths() {
    const months = new Set();
    appData.transactions.forEach(t => months.add(t.date.slice(0, 7)));
    return [...months].sort().reverse();
}

function groupByCategory(txs) {
    const map = {};
    txs.forEach(t => { map[t.category] = (map[t.category] || 0) + t.amount; });
    return Object.entries(map).map(([category, total]) => ({ category, total })).sort((a, b) => b.total - a.total);
}

function populateFilterCategories() {
    const cats = new Set();
    appData.transactions.forEach(t => cats.add(t.category));
    const sel = document.getElementById('filter-cat');
    const current = sel.value;
    sel.innerHTML = '<option value="todos">Todas las categorias</option>' +
        [...cats].sort().map(c => `<option value="${c}">${c}</option>`).join('');
    sel.value = current || 'todos';
}

function clearFilters() {
    document.getElementById('filter-type').value = 'todos';
    document.getElementById('filter-cat').value = 'todos';
    document.getElementById('filter-month').value = '';
    renderTransactions();
}

function refreshAll() {
    refreshCategorySelects();
    renderCustomCategories();
    renderDashboard();
    renderCapitalChart();
    renderTransactions();
    populateFilterCategories();
    renderIncomeStatement();
    renderBalanceSheet();
    renderCashFlow();
}

// ============================================
// INIT
// ============================================
document.getElementById('tx-date').value = new Date().toISOString().slice(0, 10);
if (appData.apiKey) document.getElementById('anthropic-key').value = appData.apiKey;

// Initialize dynamic category selects
document.getElementById('tx-category').innerHTML = getCategoryOptionsHTML();
const manualCatInit = document.getElementById('manual-cat-initial');
if (manualCatInit) manualCatInit.innerHTML = getCategorySimpleOptionsHTML();
renderCustomCategories();

// ============================================
// ONE-TIME BALANCE SEED (runs once, then marks as done)
// ============================================
if (!appData._balanceSeeded) {
    const seedItems = [
        // ACTIVO CIRCULANTE
        { name: 'EFECTIVO', type: 'activo-circulante', amount: 77237.21 },
        { name: 'INVERSION SANTANDER', type: 'activo-circulante', amount: 0 },
        { name: 'INVERSION BBVA', type: 'activo-circulante', amount: 1606157.26 },
        { name: 'INVERSION ETORO', type: 'activo-circulante', amount: 0 },
        { name: 'INVERSION FONDO', type: 'activo-circulante', amount: 0 },
        { name: 'DEUDA VALENTIN', type: 'activo-circulante', amount: 500000.00 },
        { name: 'CUENTAS', type: 'activo-circulante', amount: 20000.00 },
        { name: 'SEGURO GNP VICTORIA', type: 'activo-circulante', amount: 127502.28 },
        { name: 'SEGURO GNP EDUARDO', type: 'activo-circulante', amount: 174831.12 },
        // ACTIVO FIJO
        { name: 'CIESC', type: 'activo-fijo', amount: 60000.00 },
        { name: 'SALUZ', type: 'activo-fijo', amount: 1315000.00 },
        { name: 'CASA 2', type: 'activo-fijo', amount: 2033500.00 },
        { name: 'CASA 3', type: 'activo-fijo', amount: 686871.79 },
        { name: 'LOFT 6', type: 'activo-fijo', amount: 2100000.00 },
        { name: 'LOFT 7', type: 'activo-fijo', amount: 2100000.00 },
        { name: 'CASA 8', type: 'activo-fijo', amount: 1561850.00 },
        { name: 'CASA 9', type: 'activo-fijo', amount: 2500000.00 },
        { name: 'CASA 15', type: 'activo-fijo', amount: 1500000.00 },
        { name: 'CASA 5', type: 'activo-fijo', amount: 142000.00 },
        { name: 'CASA PLAYAS', type: 'activo-fijo', amount: 6700000.00 },
        { name: 'LINCOLN CAMIONETA', type: 'activo-fijo', amount: 750000.00 },
        { name: 'TERRENO OAK VILLAGE', type: 'activo-fijo', amount: 7133820.00 },
        { name: 'SECUNDARIA TRANSMODAL', type: 'activo-fijo', amount: 7844171.77 },
        { name: 'TERRENO PUNTA TIBURON', type: 'activo-fijo', amount: 6000000.00 },
        // PASIVO A CORTO PLAZO
        { name: 'DEUDA TERRENO PUNTA', type: 'pasivo-corto', amount: 0 },
        { name: 'TARJETA DE CREDITO SANTANDER', type: 'pasivo-corto', amount: 2709.00 },
        { name: 'TARJETA DE CREDITO BBVA', type: 'pasivo-corto', amount: 228535.00 },
        { name: 'TARJETA DE CREDITO SCOTIABANK', type: 'pasivo-corto', amount: 34658.12 },
        { name: 'TARJETA DE CREDITO AMEX', type: 'pasivo-corto', amount: 53232.00 },
        // PASIVO A LARGO PLAZO
        { name: 'DEUDA VICTOR 8', type: 'pasivo-largo', amount: 600000.00 },
        { name: 'DEUDA TERRENO EHB', type: 'pasivo-largo', amount: 0 },
        { name: 'AMEX MESES SIN INTERESES', type: 'pasivo-largo', amount: 56472.49 },
        { name: 'DEUDA DANIELA', type: 'pasivo-largo', amount: 307747.20 },
        { name: 'CREDITO SCOTIABANK 1', type: 'pasivo-largo', amount: 4588462.66 },
        { name: 'CREDITO SCOTIABANK 2', type: 'pasivo-largo', amount: 3442224.82 },
    ];
    seedItems.forEach(item => {
        appData.balanceItems.push({
            id: Date.now() + Math.random() * 10000,
            name: item.name,
            type: item.type,
            amount: item.amount
        });
    });
    appData._balanceSeeded = true;
    appData.balanceLastUpdate = appData.balanceLastUpdate || '2026-01-27';
    if (!appData.balanceHistory) appData.balanceHistory = [];
    saveData(appData);
    saveBalanceSnapshot();
}

refreshAll();
</script>

</body>
</html>
